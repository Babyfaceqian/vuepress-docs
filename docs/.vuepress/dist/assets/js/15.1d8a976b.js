(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{140:function(t,s,a){"use strict";a.r(s);var e=a(0),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"travis自动构建部署服务搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#travis自动构建部署服务搭建","aria-hidden":"true"}},[t._v("#")]),t._v(" Travis自动构建部署服务搭建")]),t._v(" "),a("h2",{attrs:{id:"准备工作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备工作","aria-hidden":"true"}},[t._v("#")]),t._v(" 准备工作")]),t._v(" "),a("ol",[a("li",[t._v("待部署的github仓库")]),t._v(" "),a("li",[t._v("一台云服务器，这里以阿里云的centOS服务器为例")]),t._v(" "),a("li",[t._v("ssh或putty等可以登录到云服务器的工具")])]),t._v(" "),a("h2",{attrs:{id:"启用travis"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启用travis","aria-hidden":"true"}},[t._v("#")]),t._v(" 启用travis")]),t._v(" "),a("blockquote",[a("ol",[a("li",[t._v("Go to Travis-ci.com and Sign up with GitHub.")])])]),t._v(" "),a("p",[t._v("登录travis官网，用github账号登录。")]),t._v(" "),a("blockquote",[a("ol",{attrs:{start:"2"}},[a("li",[t._v("Accept the Authorization of Travis CI. You’ll be redirected to GitHub.")])])]),t._v(" "),a("p",[t._v("接受Travis CI验证，会跳转到你的github。")]),t._v(" "),a("blockquote",[a("ol",{attrs:{start:"3"}},[a("li",[t._v("Click the green Activate button, and select the repositories you want to use with Travis CI.")])])]),t._v(" "),a("p",[t._v("点击启用travis按钮，选择需要用travis构建的仓库。")]),t._v(" "),a("blockquote",[a("ol",{attrs:{start:"4"}},[a("li",[t._v("Add a "),a("code",[t._v(".travis.yml")]),t._v(" file to your repository to tell Travis CI what to do.")])])]),t._v(" "),a("p",[t._v("添加"),a("code",[t._v(".travis.yml")]),t._v("到你的仓库根目录，travis会读取这个文件作为配置内容。")]),t._v(" "),a("blockquote",[a("ol",{attrs:{start:"5"}},[a("li",[t._v("Add the "),a("code",[t._v(".travis.yml")]),t._v(" file to git, commit and push, to trigger a Travis CI build:")])])]),t._v(" "),a("p",[t._v("提交"),a("code",[t._v(".travis.yml")]),t._v("会触发travis构建。\nTravis only runs builds on the commits you push after you’ve added a .travis.yml file.")]),t._v(" "),a("blockquote",[a("ol",{attrs:{start:"6"}},[a("li",[t._v("Check the build status page to see if your build passes or fails, according to the return status of the build command by visiting the Travis CI and selecting your repository.")])])]),t._v(" "),a("p",[t._v("选择对应的仓库，查看构建状态成功还是失败。")]),t._v(" "),a("p",[t._v("参考上面官网的步骤，我们会在仓库根目录下添加"),a("code",[t._v(".travis.yml")]),t._v("文件。\n.travis.yml")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("language")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node_js\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("node_js")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8'")]),t._v("\n")])])]),a("p",[t._v("因为我们部署的是node项目，所以语言选择 "),a("code",[t._v("node_js")]),t._v("，版本选择比较高的 "),a("code",[t._v("8")]),t._v("。详细的配置可参考"),a("a",{attrs:{href:"https://docs.travis-ci.com/user/languages/javascript-with-nodejs/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官网"),a("OutboundLink")],1),t._v("。\n构建好之后在travis上就可以看到项目passed。如图所示。\n"),a("img",{attrs:{src:"evernotecid://5CEB42F5-35BD-4DEF-B080-D633405A01FA/appyinxiangcom/2715342/ENResource/p19",alt:"fac39adc6cfc4a850a19f1be66607591.png"}})]),t._v(" "),a("h2",{attrs:{id:"构建打包"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#构建打包","aria-hidden":"true"}},[t._v("#")]),t._v(" 构建打包")]),t._v(" "),a("p",[t._v("travis上的项目构建其实是跑在travis提供的一台虚拟服务器上，在job log我们可以清楚的看到构建用的虚拟服务器信息。\n"),a("img",{attrs:{src:"evernotecid://5CEB42F5-35BD-4DEF-B080-D633405A01FA/appyinxiangcom/2715342/ENResource/p20",alt:"b6c31532d9d53319048042b2412d28df.png"}}),t._v("\n这台虚拟的服务器可以做很多事情，比如构建、测试，也可以在上面执行自定义的linux命令或脚本。当然，部署服务器还是需要用自己的。我们的目的是使用travis虚拟服务器进行构建打包（暂时不考虑测试），将打包好的文件用scp传到部署服务器，再执行一些脚本启动服务。")]),t._v(" "),a("p",[t._v("修改"),a("code",[t._v(".travis.yml")]),t._v("如下")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("language")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node_js\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("node_js")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'8'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm install\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" npm run build\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("before_install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("after_success")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" scp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("r dist/ travis@39.108.158.235"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/home/travis/web/zhangqiantech\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ssh travis@39.108.158.235 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('o StrictHostKeyChecking=no "/home/travis/web/zhangqiantech/run.sh"\n\n')])])]),a("p",[t._v("这里travis虚拟服务器会帮我们处理"),a("code",[t._v("install")]),t._v("和"),a("code",[t._v("script")]),t._v("命令，打包后的目录是"),a("code",[t._v("dist")]),t._v("，在构建成功后用"),a("code",[t._v("scp")]),t._v("命令将打包后的文件放到部署服务器上。然后登陆到部署服务器执行启动服务的命令。\n由于需要让虚拟服务器能够自动登录到部署服务器执行命令，需要关联服务器。")]),t._v(" "),a("h2",{attrs:{id:"关联服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关联服务器","aria-hidden":"true"}},[t._v("#")]),t._v(" 关联服务器")]),t._v(" "),a("p",[t._v("用ssh或putty登录到部署服务器，安装travis。")]),t._v(" "),a("div",{staticClass:"language-vim extra-class"},[a("pre",{pre:!0,attrs:{class:"language-vim"}},[a("code",[t._v("$ gem install travis\n")])])]),a("p",[t._v("创建并切换到travis用户，后面会用此用户名登陆服务器。")]),t._v(" "),a("div",{staticClass:"language-vim extra-class"},[a("pre",{pre:!0,attrs:{class:"language-vim"}},[a("code",[t._v("$ useradd travis\n$ "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("su")]),t._v(" travis\n")])])]),a("p",[t._v("拉取仓库到服务器。")]),t._v(" "),a("div",{staticClass:"language-vim extra-class"},[a("pre",{pre:!0,attrs:{class:"language-vim"}},[a("code",[t._v("$ git clone git@github"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("com")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("Babyfaceqian"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("zhangqiantech"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("git\n")])])]),a("p",[t._v("登陆travis。")]),t._v(" "),a("div",{staticClass:"language-vim extra-class"},[a("pre",{pre:!0,attrs:{class:"language-vim"}},[a("code",[t._v("$ travis login\n")])])]),a("p",[t._v("cd到仓库根目录，执行下面的语句，作用是将用于免密登陆的id_rsa也就是私钥加密保存到仓库里面，travis虚拟服务器尝试登陆的时候会通过该私钥登陆到部署服务器。")]),t._v(" "),a("div",{staticClass:"language-vim extra-class"},[a("pre",{pre:!0,attrs:{class:"language-vim"}},[a("code",[t._v("$ travis encrypt"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("file")]),t._v(" ~"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("ssh"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("id_rsa "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("add\nDetected repository "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" xxx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("xxx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("is")]),t._v(" this correct"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" |yes| yes\nencrypting ~"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("ssh"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("id_rsa "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" xxx"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("xxx\nstoring result "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" id_rsa"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("enc")]),t._v("\nstoring "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("secure")]),t._v(" env variables "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" decryption\n\nMake sure "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),t._v(" add id_rsa"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("enc")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),t._v(" the git repository"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("\nMake sure not "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),t._v(" add ~"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("ssh"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("id_rsa "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),t._v(" the git repository"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("\nCommit "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("all")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("changes")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("to")]),t._v(" your "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("travis"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("yml"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(".")]),t._v("\n")])])]),a("p",[t._v("执行完后 "),a("code",[t._v(".travis.yml")]),t._v(" 的 "),a("code",[t._v("before-install")]),t._v(" 下会增加一行内容。")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("before_install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" openssl aes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("256"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cbc "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("K $encrypted_d89376f3278d_key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("iv $encrypted_d89376f3278d_iv\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("in id_rsa.enc "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("out ~\\/.ssh/id_rsa "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d\n")])])]),a("p",[t._v("为了保证权限正常，还需要添加一行内容。")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" chmod 600 ~/.ssh/id_rsa\n")])])]),a("p",[t._v("第一次登陆服务器的时候可能会出现ssh主机验证，可以通过添加 "),a("code",[t._v("addons")]),t._v(" 配置解决。")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("addons")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ssh_known_hosts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 39.108.158.235\n")])])]),a("p",[t._v("保存 "),a("code",[t._v(".travis.yml")]),t._v(" 并提交代码。现在travis可以自动免密登陆到部署服务器上执行命令了。")])])}),[],!1,null,null,null);s.default=r.exports}}]);